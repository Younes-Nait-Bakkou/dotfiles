#!/usr/bin/env bash
set -e
export GITHUB_USERNAME="Younes-Nait-Bakkou"
DOTFILES_DIR="$HOME/.dotfiles"
LOG_FILE="$HOME/.dotfiles-install.log"
ERROR_LOG_FILE="$HOME/.dotfiles-install.err"

# --- COLORS (for prettier terminal output) ---
RED="\033[31m"
GREEN="\033[32m"
RESET="\033[0m"

_log() {
    local msg="$1"
    echo -e "${GREEN}[INFO]${RESET} $msg"
    echo "$(date '+%Y-%m-%d %H:%M:%S') [INFO] $msg" >>"$LOG_FILE"
}

_error() {
    local msg="$1"
    echo -e "${RED}[ERROR]${RESET} $msg" >&2
    echo "$(date '+%Y-%m-%d %H:%M:%S') [ERROR] $msg" >>"$LOG_FILE"
    exit 1
}

_cmd() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') [CMD] $*" >>"$LOG_FILE"

    "$@" >>"$LOG_FILE" 2>&1 ||
        _error "Command failed: $*"
}
detect_os() {
    if [ -f /etc/os-release ]; then
        . /etc/os-release
        echo "$ID"
    else
        uname -s | tr '[:upper:]' '[:lower:]'
    fi
}

install_git() {
    if [ -x "$(command -v git)" ]; then
        _log "Git is already installed"
    else
        _log "Installing Git..."
        _cmd sudo apt-get install -y git
    fi
}

sync_dotfiles() {
    if [ ! -d "$DOTFILES_DIR" ]; then
        BRANCH="ansible-only"
        _log "Cloning dotfiles repo..."
        _cmd mkdir -p "$DOTFILES_DIR"
        _cmd git clone --single-branch -b "$BRANCH" https://github.com/$GITHUB_USERNAME/dotfiles.git "$DOTFILES_DIR"
    else
        _log "Updating dotfiles..."
        cd "$DOTFILES_DIR"
        _cmd git pull
    fi
}

ubuntu_setup() {
    _log "Checking Ansible installation..."

    if ! dpkg -s ansible >/dev/null 2>&1; then
        _log "Installing Ansible (May take a few minutes)"

        _cmd sudo apt-get update
        _cmd sudo apt-get install -y software-properties-common
        _cmd sudo apt-add-repository -y ppa:ansible/ansible
        _cmd sudo apt-get update
        _cmd sudo apt-get install -y ansible python3-argcomplete
    fi
}

run_os_setup() {
    case "$1" in
    ubuntu)
        ubuntu_setup
        ;;
    *)
        _error "Unsupported OS: $1"
        ;;
    esac
}

run_ansible() {
    _log "Running Ansible..."
    cd "$DOTFILES_DIR"
    _cmd ansible-playbook playbooks/setup.yml
}

main() {
    _log "Starting dotfiles installer..."

    OS="$(detect_os)"
    _log "Detected OS: $OS"

    install_git
    sync_dotfiles
    run_os_setup "$OS"
    run_ansible

    _log "Installation finished successfully!"
}

main "$@"
