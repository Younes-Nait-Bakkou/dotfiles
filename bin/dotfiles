#!/usr/bin/env bash
set -e

export GITHUB_USERNAME="Younes-Nait-Bakkou"
DOTFILES_DIR="$HOME/.dotfiles"
LOG_FILE="$HOME/.dotfiles.log"
ERROR_LOG_FILE="$HOME/.dotfiles.err"
VAULT_PASS_FILE="$HOME/.ansible-vault/vault-pass.txt"
VAULT_PASS_ARG=""

# --- COLORS (for prettier terminal output) ---
RED="\033[31m"
GREEN="\033[32m"
RESET="\033[0m"

# --- COLORS (OneDark) ---

RESET="\033[0m"
BOLD="\033[1m"

# OneDark palette mapped to ANSI escape sequences
OD_BLACK="\033[38;2;40;44;52m"
OD_RED="\033[38;2;224;108;117m"
OD_GREEN="\033[38;2;152;195;121m"
OD_YELLOW="\033[38;2;229;192;123m"
OD_BLUE="\033[38;2;97;175;239m"
OD_PURPLE="\033[38;2;198;120;221m"
OD_CYAN="\033[38;2;86;182;194m"
OD_WHITE="\033[38;2;171;178;191m"

# Styles for UI elements
OD_TEXT="${OD_WHITE}"
OD_DIM="\033[38;2;92;99;112m" # dim text
OD_SPINNER="${OD_BLUE}"       # spinner color
OD_OK="${OD_GREEN}"
OD_ERR="${OD_RED}"

# --- Spinner Animation --------------------------------------------------------

_spinner() {
    local task_text="$1"
    local chars=('⠋' '⠙' '⠹' '⠸' '⠼' '⠴' '⠦' '⠧' '⠇' '⠏')
    local delay=0.08

    tput civis # hide cursor
    tput sc    # save cursor pos

    while true; do
        for char in "${chars[@]}"; do
            tput rc
            tput el
            printf "${OD_DIM}[${OD_SPINNER}%s${OD_DIM}]  ${OD_TEXT}%s${RESET}" "$char" "$task_text" >&2
            sleep $delay
        done
    done
}

__task() {
    if [[ -n "$TASK" ]] && [[ -n "$SPINNER_PID" ]]; then
        _task_done
    fi

    TASK="$1"
    _spinner "$TASK" &

    SPINNER_PID=$!
    disown $SPINNER_PID 2>/dev/null
}

_task_done() {
    if [[ -n "$SPINNER_PID" ]]; then
        kill "$SPINNER_PID" 2>/dev/null
        wait "$SPINNER_PID" 2>/dev/null
        SPINNER_PID=""
    fi

    tput cnorm
    printf "\r\033[K${OD_OK}[✓]${OD_TEXT} %s${RESET}\n" "$TASK"
    TASK=""
}

_task_fail() {
    if [[ -n "$SPINNER_PID" ]]; then
        kill "$SPINNER_PID" 2>/dev/null
        wait "$SPINNER_PID" 2>/dev/null
        SPINNER_PID=""
    fi

    tput cnorm
    printf "\r\033[K${OD_ERR}[✗]${OD_TEXT} %s${RESET}\n" "$TASK"
    TASK=""
}

_log() {
    local msg="$1"
    echo -e "${GREEN}[INFO]${RESET} $msg"
    echo "$(date '+%Y-%m-%d %H:%M:%S') [INFO] $msg" >>"$LOG_FILE"
}

_error() {
    local msg="$1"
    echo -e "${RED}[ERROR]${RESET} $msg" >&2
    echo "$(date '+%Y-%m-%d %H:%M:%S') [ERROR] $msg" >>"$LOG_FILE"
    exit 1
}

_cmd() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') [CMD] $*" >>"$LOG_FILE"

    eval "$@" >>"$LOG_FILE" 2>&1 && {
        _task_done
    } || {
        _task_fail
        printf "\n${OD_ERR}Error log:${RESET}\n" >&2
        sed 's/^/    /' "$LOG_FILE" >&2
        exit 1
    }
}

detect_os() {
    if [ -f /etc/os-release ]; then
        . /etc/os-release
        echo "$ID"
    else
        uname -s | tr '[:upper:]' '[:lower:]'
    fi
}

install_git() {
    if [ -x "$(command -v git)" ]; then
        _log "Git is already installed"
    else
        _log "Installing Git..."
        _cmd sudo apt-get install -y git
    fi
}

sync_dotfiles() {
    if [ ! -d "$DOTFILES_DIR" ]; then
        BRANCH="ansible-only"
        _log "Cloning dotfiles repo..."
        _cmd mkdir -p "$DOTFILES_DIR"
        _cmd git clone --single-branch -b "$BRANCH" https://github.com/$GITHUB_USERNAME/dotfiles.git "$DOTFILES_DIR"
    else
        _log "Updating dotfiles..."
        cd "$DOTFILES_DIR"
        _cmd git pull
    fi
}

ubuntu_setup() {
    _log "Checking Ansible installation..."

    if ! dpkg -s ansible >/dev/null 2>&1; then
        _log "Installing Ansible (May take a few minutes)"

        _cmd sudo apt-get update
        _cmd sudo apt-get install -y software-properties-common
        _cmd sudo apt-add-repository -y ppa:ansible/ansible
        _cmd sudo apt-get update
        _cmd sudo apt-get install -y ansible python3-argcomplete
    fi
}

run_os_setup() {
    case "$1" in
    ubuntu)
        ubuntu_setup
        ;;
    *)
        _error "Unsupported OS: $1"
        ;;
    esac
}

get_vault_password_arg() {
    # Returns the vault password argument for Ansible

    if [[ -f "$VAULT_PASS_FILE" ]]; then
        echo "--vault-password-file $VAULT_PASS_FILE"
    else
        echo -e "${OD_YELLOW}Vault password file not found.${RESET}"
        read -rsp "Enter vault password for one-time use: " VAULT_PASS
        echo

        TMP_VAULT_FILE=$(mktemp)
        echo "$VAULT_PASS" >"$TMP_VAULT_FILE"
        chmod 600 "$TMP_VAULT_FILE"

        echo "--vault-password-file $TMP_VAULT_FILE"
    fi
}

run_ansible() {
    _log "Running Ansible..."
    cd "$DOTFILES_DIR"

    VAULT_PASS_ARG=$(get_vault_password_arg)

    local extra_args=("$@") # capture all arguments

    _cmd ansible-playbook "$DOTFILES_DIR/playbooks/setup.yml" "$VAULT_PASS_ARG" --ask-become-pass "${extra_args[@]}"
}

clean_up_vault_pass() {
    if [[ -f "$TMP_VAULT_FILE" ]]; then
        rm "$TMP_VAULT_FILE"
    fi
}

main() {
    _log "Starting dotfiles installer..."

    OS="$(detect_os)"
    _log "Detected OS: $OS"

    install_git
    sync_dotfiles
    run_os_setup "$OS"
    run_ansible "$@"
    clean_up_vault_pass

    _log "Installation finished successfully!"
}

main "$@"
